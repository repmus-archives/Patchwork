(in-package "C-PATCH-BOX-KANT")(defvar *old-pos-staff* pw::*MN-C5*)(defmethod delete-m3  ((self C-MN-view-mod-kant))       (delete-marca self 31 )       (delete-marca self 32 )       (delete-marca self 33 ))(defmethod update-menu  ((self C-MN-view-mod-kant) ) (case (active-menu self)              (1 (prog1 (disable-menu self 3 )                       (disable-menu self 2 )                       (setf (pw::chords (pw::chord-seq (papa self)))                              (butlast (mk-aficha  (entre self)) (length (entre self))))                       (mapc #'(lambda (mes) (pw::update-all-notes mes)) (editor-objects self))                       (setf (resume-selected self) nil)                       (setf (resume-m1 self)  (copy-tree (domaine self)))                       (setf (selection-m1 self) nil)))             (2 (prog1 (disable-menu self 3 )                       (setf (pw::chords (pw::chord-seq (papa self)))                              (butlast (mk-aficha  (entre2 self)) (length (entre2 self))))                       (mapc #'(lambda (mes) (pw::update-all-notes mes)) (editor-objects self)))))) (defmethod show-menu  ((self C-MN-view-mod-kant)  sp ph)  (case (active-menu self)     (1  (let ((k 1))          (delete-marca self 1)          (draw-resume self 1 sp ph)          (mapc #' (lambda (mes) (declare (ignore mes))                           (draw-marca self (+ 10 k) sp ph)                           (setf k (+ k 1))) (marcas-archi self))))    (2 (let (( k 1))         (delete-marca self 1)         (draw-resume self 1 sp ph)         (mapc #' (lambda (mes)                     (declare (ignore mes))                    (draw-marca self (+ 20 k) sp ph)                    (setf k (+ k 1))) (marcas-seg self))))))(defmethod kill-bpf ((self C-MN-view-mod-kant))  (when (bpf self)    (window-close (bpf self))    (setf (bpf self) nil))  (when (bpf-p self)    (window-close (bpf-p self))    (setf (bpf-p self) nil))  (when (bpf-v self)    (window-close (bpf-v self))    (setf (bpf-v self) nil)))(defmethod pw::remove-yourself-control :before ((self C-patch-box-kant))  (kill-bpf (car (subviews (application-object self)))))(defmethod kant-up-editor ((self C-MN-view-mod-kant) newsize)  (let* (( sp (point-h (view-scroll-position (car (editor-objects self)))))         ( ph (- (point-h newsize) 43)) )    (cond      ((eq (active-menu self) 1)      (let (( k 1))        (mapc #' (lambda (mes) (declare (ignore mes))                         (delete-marca self (+ 10 k))                         (draw-marca self (+ 10 k)  sp ph)                         (setf k (+ k 1))) (marcas-archi self))))     ((eq (active-menu self) 2)      (let   (( k 1))          (mapc #' (lambda (mes) (declare (ignore mes))                         (delete-marca self (+ 20 k))                         (draw-marca self (+ 20 k)  sp ph)                         (setf k (+ k 1))) (marcas-seg self))))     ((eq (active-menu self) 3)      (progn (delete-marca self 8) (draw-resume self 8 sp ph)             (delete-marca self 2) (draw-resume self 2 sp ph)             (when (vis-forbid self) (delete-marca self 31) (draw-par self 31 sp ph))             (when (vis-preci self) (delete-marca self 32) (draw-par self 32 sp ph))             (when (vis-max self) (delete-marca self 33) (draw-par self 33 sp ph)))))    (delete-marca self 1)     (draw-resume self 1  sp ph)))(defmethod view-draw-contents :after ((self C-MN-view-mod-kant))  (without-interrupts ;; GA 160996 this function seems to be reentered illegally ???   (declare (special *current-MN-editor* ))    (setf *current-MN-editor* self)   (setf  pw::*MN-C5* (- (point-v (view-size (car (editor-objects self)))) 20))   (if (not (=  (pw::MN-zoom-scaler self) (ant-zoom self)))     (progn       (kant-up-editor self (view-size (car (editor-objects self))))       (setf (ant-zoom self) (pw::MN-zoom-scaler self))))   (if  (not (eq (cambio-marca self) 0))        (prog1       (delete-marca self (cambio-marca self) )       (draw-marca self (cambio-marca self) (point-h (view-scroll-position  (car (editor-objects self))))                    (- (point-h (view-size (car (editor-objects self)))) 43))       (setf (cambio-marca self) 0)))   (if  (< (active-menu self) (ant-menu self))     (let (( k 1))       (mapc #' (lambda (mes) (declare (ignore mes))                        (delete-marca self (+ 20 k))                        (setf k (+ k 1))) (marcas-seg self))       (delete-marca self 8)       (delete-marca self 2)       (delete-m3 self )       (update-menu self )       (setf  pw::*MN-C5* (- (point-v (view-size (car (editor-objects self)))) 20))       (show-menu self  (point-h (view-scroll-position (car (editor-objects self))))                   (- (point-h (view-size (car (editor-objects self)))) 43))))   (if  (not (zerop (cambio-par self)))      (prog1       (delete-marca self 33 )       (delete-marca self 32 )       (delete-marca self 31 )       (draw-par self (cambio-par self) (point-h (view-scroll-position (car (editor-objects self))))                  (- (point-h (view-size (car (editor-objects self)))) 43))       (setf (cambio-par self) 0)))   (if  (not (zerop (cambio-resume self)))      (let (( k 1))       (mapc #' (lambda (mes) (declare (ignore mes))                        (delete-marca self (+ 20 k))                        (setf k (+ k 1))) (marcas-seg self))       (delete-marca self 2)       (delete-marca self 8)       (setf k 1)       (mapc #' (lambda (mes) (declare (ignore mes))                         (delete-marca self (+ 10 k))                        (setf k (+ k 1))) (marcas-archi self))       (delete-marca self 1)        (if (eq (cambio-resume self) 2)         (progn           (draw-resume self 1 (point-h (view-scroll-position (car (editor-objects self))))                        (- (point-h (view-size (car (editor-objects self)))) 43))           (draw-resume self 8 (point-h (view-scroll-position (car (editor-objects self))))                         (- (point-h (view-size (car (editor-objects self)))) 43)))         (setf (selection-m1 self) 0 (resume-selected self) nil))       (draw-resume self (cambio-resume self) (point-h (view-scroll-position (car (editor-objects self))))                     (- (point-h (view-size (car (editor-objects self)))) 43))       (setf (cambio-resume self) 0)))   (setf  pw::*MN-C5* *old-pos-staff*)   (setf (ant-menu self) (active-menu self))))(defmethod view-draw-contents ((self C-MN-panel-Mod-kant))  (setf  pw::*MN-C5* (- (point-v (view-size self)) 20))  (call-next-method)  (tell (subviews self) 'view-draw-contents)  (setf  pw::*MN-C5* *old-pos-staff*))(defmethod update-editor ((self C-MN-view-mod-kant))  (pw::update-view-controler self))(defmethod set-staff-count ((self C-MN-view-mod-kant) value)  (let* ((all-panels (editor-objects self))           (current-length (length all-panels)))      (cond ((< value current-length)             (pw::unselect-all-chords (car all-panels) 0 0)             (apply #'remove-subviews (cons self (nthcdr value all-panels)))             (setf (editor-objects self) (butlast (editor-objects self) (- current-length value)))             (pw::view-window-grown self)             (ccl::scroll-bar-changed (car all-panels) (ccl::v-scroller (car all-panels))))            ((> value current-length)             (pw::unselect-all-chords (car all-panels) 0 0)             (let ((size (view-size (car all-panels)))                   (max-y                    (apply 'max  (mapcar #'(lambda (panel) (+ (point-v (view-size panel))                                                              (point-v (view-position panel))))                                         all-panels)))                   (last-panel-home (origin (car (last all-panels))))                   new-panels editor-now)               (dotimes (i (- value current-length))                 (push                  (setq editor-now                        (make-instance 'C-MN-panel-Mod-kant                          :view-container self                          :view-position (make-point 0 (+ 2 max-y))                          :view-size size                          :h-scrollp nil                          :staff-list pw::*g-plain-staffs*                          :view-font '("MusNot-j"  18  :srcor)                          :origin                           (setq last-panel-home (+ last-panel-home (- pw::*MN-draw-offset*) (point-h size)))))                  new-panels)                 (setq max-y (+ 2 max-y (point-v size)))                 (setf (chord-line editor-now) (chord-line (car all-panels))))               (setf (editor-objects self) (nconc all-panels (nreverse new-panels)))               (pw::view-window-grown self)               (ccl::scroll-bar-changed (car all-panels) (ccl::v-scroller (car all-panels)))))            (t nil))))(defclass C-bar-archi (simple-view)   ((barra :initform #\& :initarg :clef :accessor barra)    (delta-y :initform 0 :initarg :delta-y :accessor delta-y)))(defmethod monofonic-mn? ((self C-MN-view-mod-kant))   (not (pw::polifonic? (pw::pw-object (view-container self)))))(defmethod update-editor-objects ((self C-MN-view-mod-kant)) (tell (editor-objects self) 'update-editor))(defmethod update-all-chord-lines ((self C-MN-view-mod-kant) chord-lines)  (let ((editors (editor-objects self)))     (while (and chord-lines editors)       (setf (chord-line (pop editors)) (pop chord-lines)))))(defmethod scroll-editor-to-home ((self C-MN-view-mod-kant))     (update-editor self))(in-package :pw);aaa je triche mais c'est pas ma faute !!!!!!(defmethod window-grow-event-handler :after ((self c-patch-box-kant::C-mn-window-mod-kant) where)  (declare (ignore where))  (let* ((the-view (car (editor-objects (first (subviews self)))))         (the-scroll (ccl::v-scroller the-view)))    (ccl::scroll-bar-changed the-view the-scroll)))(defmethod view-window-grown ((self c-patch-box-kant::C-MN-view-mod-kant))  (declare (special *MN-view-ctrls-space* *mn-draw-offset*))  (set-view-size self                  (subtract-points (view-size (view-window self)) (make-point 15 25)))  (let* ((new-view-size           (subtract-points (view-size  self) *MN-view-ctrls-space*))         (objects (editor-objects self))         (v-size (truncate (point-v new-view-size) (length objects)))         (pos 2) (origin-count 0) (adjusted-size (- (point-h new-view-size) *MN-draw-offset*)))    (setf  *MN-C5* (- v-size 26))    (dolist (panel objects)      (event-dispatch)      (set-view-position panel  (make-point (point-h (view-position panel)) pos))      ;(if (monofonic-mn? self) (setf (origin panel) origin-count))      (setf (origin panel) origin-count)      (if (monofonic-mn? self) (incf origin-count adjusted-size))      (set-view-size panel (make-point (point-h new-view-size) (- v-size 6)))      (incf pos v-size))    (c-patch-box-kant::kant-up-editor self new-view-size)    (setf  *MN-C5* c-patch-box-kant::*old-pos-staff*)))(defmethod scroll-bar-changed ((view C-PATCH-BOX-KANT::C-MN-view-mod-kant) scroll-bar)  (when (not (= (scroll-bar-setting scroll-bar) (c-patch-box-kant::ant-scroll view)))    (setf  *MN-C5* (- (point-v (view-size (car (editor-objects view)))) 20))  (let ((new-value (point-h (scroll-bar-setting scroll-bar)))        (panels (editor-objects view)))    (dolist (panel panels)      (set-origin panel (make-point new-value (point-v (view-scroll-position panel)))))    (c-patch-box-kant::kant-up-editor view (view-size (car (editor-objects view))))    (setf (c-patch-box-kant::ant-scroll view) (scroll-bar-setting scroll-bar))    (setf  *MN-C5* c-patch-box-kant::*old-pos-staff*))))(defmethod key-pressed-MN-editor ((self C-PATCH-BOX-KANT::C-MN-view-mod-kant) char)  (cond ((eq char #\Delete ) (C-PATCH-BOX-KANT::delete-selec self -150))        ((eq char #\+ ) (C-PATCH-BOX-KANT::f-union-inter self char ))        ((eq char #\= ) (C-PATCH-BOX-KANT::f-aligne-chords self  ))        ((eq char #\* ) (C-PATCH-BOX-KANT::f-union-inter self char))        ((eq char #\BackArrow ) (C-PATCH-BOX-KANT::shift-marca self -1))        ((eq char #\ForwardArrow ) (C-PATCH-BOX-KANT::shift-marca self 1))        ((eq char #\p) (play-all-staffs self))        (t (when (active-editor self) (handle-key-event (active-editor self) char))))  (C-PATCH-BOX-KANT::view-draw-contents self))(defmethod draw-note-4  ((self C-note) x C5 t-scfactor)  (declare (special *mn-view-time-flag*))  (let ((y-now (give-pixel-y self C5))        (x-now (if (not (equal (class-name (class-of *current-view*)) 'c-patch-box-kant::c-mn-panel-mod-kant))                 (+ x (delta-x self))                 (+ 6 (+ x (delta-x self)))))        (alt (alteration self)))    (if (< 0 (dur self))     (draw-char x-now y-now #\w)     (draw-char x-now y-now #\Î))      (when t-scfactor      (if *mn-view-dyn-flag*        (draw-note-symbolic-dynamic self x-now y-now))      (if *mn-view-dur-flag*        (draw-note-duration-line self x-now y-now t-scfactor))      (if (and *mn-view-offset-flag* (not *mn-view-time-flag*))        (draw-note-offset-line self x-now y-now t-scfactor)) )       (when (and (instrument self) *mn-view-ins-flag* t-scfactor)        (draw-char x-now y-now #\½)       (draw-instrument (instrument self) x-now y-now (round (+ (* t-scfactor (dur self))))))    (if (and alt (not (eq *staff-num* 7) ))  ; empty staff        (draw-char (+ x (alt-delta-x self)) y-now alt))))(defmethod draw-chord  ((self C-chord) t-scfactor beg-x time1 C5 &optional mode) (setq *MN-note-ins-y* *MN-global-ins-y*) (when (notes self)  (let ((x-now (calc-chord-pixel-x self t-scfactor beg-x time1)))    (if (not (equal (class-name (class-of *current-view*)) 'c-patch-box-kant::c-mn-panel-mod-kant))     (draw-stem self x-now C5 mode))    (tell (give-all-draw-notes self) 'draw-note-4 x-now C5 t-scfactor)     (draw-extra-info self x-now C5 mode))))(defmethod open-application-help-window ((self C-PATCH-BOX-KANT::C-MN-window-mod-kant))  (declare (special *kant-help-window*))   (if *kant-help-window*         (unless (wptr  *kant-help-window*) (make-MN-help-kant-window))         (make-MN-help-kant-window))   (window-select *kant-help-window*))