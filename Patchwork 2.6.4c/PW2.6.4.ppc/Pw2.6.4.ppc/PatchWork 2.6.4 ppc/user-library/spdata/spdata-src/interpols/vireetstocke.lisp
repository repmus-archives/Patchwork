(in-package :spdata)(defmethod vire-ou-stocke ((self C-spdata-seq) confiance nber weightmax)  "donne les plages de stabilit des accords, les zones non stables sont reprsentes par des notes gravesseuil de tolerance en % de freq (par defaut 0.03 serait egal au n1/4 de ton)confiance = 0 => toujours diffrent, confiance = 999 => toujours egalnber = nbre de notes max pour la comparaison, les plus perceptives weightmax 0.2 par exemple"(let* ((spdatas (slot-value self 'spdata))         (spdatas-new ())         (new-spdata-seq (make-instance 'C-spdata-seq))         (spdata-i-moins-1 (pop spdatas)))    (while spdatas      (cond       ((special-equal (car spdatas) spdata-i-moins-1 confiance nber weightmax)        (push (pop spdatas) spdatas-new)        (setf spdata-i-moins-1 nil))       ((special-equal (car spdatas)(car spdatas-new) confiance nber weightmax)        (pop spdatas))       (t         (push (mk-perturb (frame (car spdatas))) spdatas-new)        (setf spdata-i-moins-1 (pop spdatas)))))    (setf (spdata new-spdata-seq) (reverse spdatas-new))    new-spdata-seq))(defun mk-perturb (time)  (let ((pert (make-instance 'C-spdata)))   (setup pert '(8.1757) '(0) '(0) '(0) '(1) '(1) () ())(setf (frame pert) time)  pert));(let ((sd (mk-perturb)));  (weights sd))(defun special-equal (spdata1 spdata2 confiance &optional nber weightmax)  "decide si spdata1 et spdata2 sont egaux (t) ou non (nil)seuil de tolerance en % de freq (par defaut 0.03 serait egal au n1/4 de ton)confiance = 0 => toujours diffrent, confiance = 999 => toujours egalnber = nbre de notes max pour la comparaison, les plus perceptives weightmax 0.2 par exemple"  (if (or (null spdata1)(null spdata2)) nil      (let ((datas1 (getdatas spdata1))(datas2 (getdatas spdata2)) nmax (test t))       (if weightmax (setf datas1 (remove weightmax datas1 :test '> :key 'third)      datas2 (remove weightmax datas2 :test '> :key 'third)))        (setf nmax (if nber (min nber (length datas1)(length datas2))                       (min (length datas1)(length datas2))))        (dotimes (n nmax test)          (setf test (and test (< (abs (1- (/ (car (nth n datas1))(car (nth n datas2)))))                                  confiance))))))  );(let ((aze '((a 1)(b 2)(c 0.5)(d 1))));  (setf aze (remove  0.9 aze :test '> :key 'second));  aze)(defun getdatas (spdata)  "tri des triplets freq, amp, weight par ordre de weight decroissant"  (sort (pw::mat-trans (list (freqs spdata)                       (amps spdata)                       (weights spdata)))  '> :key 'third)  );(sort '((1 2 3)(3 2 1)(2 2 2)) '> :key 'third)(defun frame-spnonnul (spseq)  (let ((L (spdata spseq))(Lr ()))    (dolist (sp L (reverse Lr))      (if (null (freqs sp))()(push (frame sp) Lr)))));(remove 2 '((1 1 1)(2 1 2)(1 1 1)) :test '> :key 'third)